name: Build and Publish Docker Image

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      IMAGE_VERSION:
        description: 'Custom image version (optional)'
        required: false
        type: string
      platforms:
        description: 'Platforms to build (comma-separated)'
        required: true
        default: 'linux/amd64,linux/arm64'
        type: choice
        options:
          - 'linux/amd64,linux/arm64'
          - 'linux/amd64'
          - 'linux/arm64'
      skip_cache:
        description: 'Skip cache'
        required: false
        type: boolean
        default: false

# ä¼˜åŒ– 2: å¹¶å‘æŽ§åˆ¶ - åŒä¸€åˆ†æ”¯çš„æ–° Push å–æ¶ˆæ—§æž„å»º
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ä¼˜åŒ– 1: æƒé™æŽ§åˆ¶ - æœ€å°æƒé™åŽŸåˆ™
permissions:
  contents: write # éœ€è¦ write æƒé™æ¥åˆ›å»º GitHub Release
  packages: write # å¦‚æžœå°†æ¥è¦æŽ¨é€åˆ° GHCR å¯èƒ½éœ€è¦è¿™ä¸ªï¼Œæš‚æ—¶ç•™ç€æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼Œæˆ–è€…åˆ é™¤ä¹Ÿå¥½ã€‚è¿™é‡Œä¸»è¦ä¸ºäº† Releaseã€‚

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # ä¼˜åŒ– 4: è¶…æ—¶è®¾ç½®
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        # ä»…åœ¨éž PR æ—¶ç™»å½•
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Generate custom tag
        id: custom_tag
        run: |
          if [ -n "${{ inputs.IMAGE_VERSION }}" ]; then
            echo "tag=${{ inputs.IMAGE_VERSION }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ env.IMAGE_VERSION }}" ]; then
            echo "tag=${{ env.IMAGE_VERSION }}" >> $GITHUB_OUTPUT
          else
            echo "tag=$(date +'%Y%m%d%H%M%S')-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/azins-toolkit
          tags: |
            type=raw,value=${{ steps.custom_tag.outputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha

      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          # Manual Trigger å¢žå¼º: å¯é€‰æž¶æž„
          platforms: ${{ inputs.platforms || 'linux/amd64,linux/arm64' }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Manual Trigger å¢žå¼º: skip_cache
          cache-from: ${{ inputs.skip_cache && '' || 'type=gha' }}
          cache-to: ${{ inputs.skip_cache && '' || 'type=gha,mode=max' }}

      # æ˜“ç”¨æ€§ 2: è‡ªåŠ¨åˆ›å»º/æ›´æ–° GitHub Release (ä»…é’ˆå¯¹ Tag)
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # è‡ªåŠ¨è¿½åŠ  Docker é•œåƒä¿¡æ¯åˆ° Release Body
          body: |
            ## Docker Image
            - **Image**: `${{ secrets.DOCKER_USERNAME }}/azins-toolkit:${{ steps.meta.outputs.version }}`
            - **Digest**: `${{ steps.build-and-push.outputs.digest }}`

            ### Pull Command
            ```bash
            docker pull ${{ secrets.DOCKER_USERNAME }}/azins-toolkit:${{ steps.meta.outputs.version }}
            ```
          generate_release_notes: true
          # å¦‚æžœ Release å·²å­˜åœ¨ï¼Œè¿½åŠ å†…å®¹è¿˜æ˜¯æ›¿æ¢ï¼Ÿsoftprops é»˜è®¤æ˜¯ updateã€‚
          # è¿™é‡Œä¸è®¾ç½® append_bodyï¼Œé»˜è®¤è¡Œä¸ºé€šå¸¸ç¬¦åˆé¢„æœŸã€‚

      # æ˜“ç”¨æ€§ 3: Job Summary (æ— è®ºä»€ä¹ˆè§¦å‘éƒ½æ˜¾ç¤º)
      - name: Generate Job Summary
        if: always()
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tags** | \`${{ steps.meta.outputs.tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Digest** | \`${{ steps.build-and-push.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
